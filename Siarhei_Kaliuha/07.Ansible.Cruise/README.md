# Homework report for 07.Ansible.Cruise by Siarhei Kaliuha

---

### Using virtual hosts in [IT Academy](https://www.it-academy.by/) lab environment (according list of the group: host21 - Centos, host22 - Debian).

## In this lab created two roles **webserver** and **testing**.

## Role **webserver** 

Role **webserver** provide deploy of Nginx webserver and setup two _virtual hosts_ on each lab host depending on its operation system (tasks decribed in `main.yaml`). 
* For installation packages on different OS used tasks decribed in `http_deb.yaml` and `http_rh.yaml`.
* After packages installation and basic preparation used group of tasks decribed in `nginx_setup.yaml` for setup - the main purpose is to create all needed folders, files, symlinks. Solution using the same Nginx _virtual hosts_ **configuration folders structure** both for Debian and Centos deoloyments.
* Configuration files generates using **templates**.
* Checking deployment and validating functionality of _virtual hosts_ performed by tasks described in `check_deploy.yaml` (port availability, name resolve, content check).

## Output of playing **webserver** role:

```
vagrant@vagrant-ubuntu-20:~/07.Ansible.Cruise$ ansible-playbook -i inventory.yaml web.yaml -l "all_workers" -u root --ask-vault-pass
Vault password:

PLAY [all_workers] **************************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] **********************************************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:18 +0000 (0:00:00.084)       0:00:00.084 *********
ok: [host21]
ok: [host22]

TASK [webserver : Include deploy for Debian systems] ****************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:21 +0000 (0:00:03.237)       0:00:03.322 *********
skipping: [host21]
included: /home/vagrant/07.Ansible.Cruise/roles/webserver/tasks/http_deb.yaml for host22

TASK [webserver : Nginx. Install packages] **************************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:22 +0000 (0:00:00.289)       0:00:03.611 *********
ok: [host22]

TASK [webserver : Nginx. Enable and start service] ******************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:25 +0000 (0:00:03.140)       0:00:06.752 *********
ok: [host22]

TASK [webserver : Nginx. Deploy on debian] **************************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:27 +0000 (0:00:01.757)       0:00:08.509 *********
included: /home/vagrant/07.Ansible.Cruise/roles/webserver/tasks/nginx_setup.yaml for host22 => (item=local-deb.site1)
included: /home/vagrant/07.Ansible.Cruise/roles/webserver/tasks/nginx_setup.yaml for host22 => (item=local-deb.site2)

TASK [webserver : Nginx. Remove default index.html file] ************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:27 +0000 (0:00:00.283)       0:00:08.793 *********
ok: [host22]

TASK [webserver : Nginx. Creating site directory] *******************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:28 +0000 (0:00:01.235)       0:00:10.028 *********
ok: [host22]

TASK [webserver : Nginx. Creating new config directory for sites] ***************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:29 +0000 (0:00:01.016)       0:00:11.044 *********
ok: [host22]

TASK [webserver : Nginx. Creating symlink directory] ****************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:30 +0000 (0:00:01.069)       0:00:12.114 *********
ok: [host22]

TASK [webserver : Nginx. Copy index.html file] **********************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:31 +0000 (0:00:01.058)       0:00:13.173 *********
ok: [host22]

TASK [webserver : Nginx. Copy site configuration file] **************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:33 +0000 (0:00:01.852)       0:00:15.026 *********
ok: [host22]

TASK [webserver : Nginx. Creating symlink for site] *****************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:35 +0000 (0:00:01.548)       0:00:16.574 *********
skipping: [host22]

TASK [webserver : Nginx. Remove default index.html file] ************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:35 +0000 (0:00:00.150)       0:00:16.725 *********
ok: [host22]

TASK [webserver : Nginx. Creating site directory] *******************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:36 +0000 (0:00:01.019)       0:00:17.745 *********
ok: [host22]

TASK [webserver : Nginx. Creating new config directory for sites] ***************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:37 +0000 (0:00:00.997)       0:00:18.742 *********
ok: [host22]

TASK [webserver : Nginx. Creating symlink directory] ****************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:38 +0000 (0:00:01.081)       0:00:19.823 *********
ok: [host22]

TASK [webserver : Nginx. Copy index.html file] **********************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:39 +0000 (0:00:01.007)       0:00:20.831 *********
ok: [host22]

TASK [webserver : Nginx. Copy site configuration file] **************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:41 +0000 (0:00:01.643)       0:00:22.474 *********
ok: [host22]

TASK [webserver : Nginx. Creating symlink for site] *****************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:42 +0000 (0:00:01.587)       0:00:24.061 *********
skipping: [host22]

TASK [webserver : Include deploy for RedHat systems] ****************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:42 +0000 (0:00:00.083)       0:00:24.145 *********
skipping: [host22]
included: /home/vagrant/07.Ansible.Cruise/roles/webserver/tasks/http_rh.yaml for host21

TASK [webserver : Add repository] ***********************************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:43 +0000 (0:00:00.291)       0:00:24.437 *********
ok: [host21]

TASK [webserver : Nginx. Install packages] **************************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:44 +0000 (0:00:01.092)       0:00:25.530 *********
ok: [host21]

TASK [webserver : Nginx. Enable and start service] ******************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:45 +0000 (0:00:01.548)       0:00:27.079 *********
ok: [host21]

TASK [webserver : Nginx. Enable firewall port] **********************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:46 +0000 (0:00:01.136)       0:00:28.215 *********
ok: [host21]

TASK [webserver : Nginx. Deploy on redhat] **************************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:48 +0000 (0:00:01.497)       0:00:29.713 *********
included: /home/vagrant/07.Ansible.Cruise/roles/webserver/tasks/nginx_setup.yaml for host21 => (item=local-cent.site1)
included: /home/vagrant/07.Ansible.Cruise/roles/webserver/tasks/nginx_setup.yaml for host21 => (item=local-cent.site2)

TASK [webserver : Nginx. Remove default index.html file] ************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:48 +0000 (0:00:00.234)       0:00:29.947 *********
ok: [host21]

TASK [webserver : Nginx. Creating site directory] *******************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:49 +0000 (0:00:00.927)       0:00:30.874 *********
ok: [host21]

TASK [webserver : Nginx. Creating new config directory for sites] ***************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:50 +0000 (0:00:00.987)       0:00:31.861 *********
ok: [host21]

TASK [webserver : Nginx. Creating symlink directory] ****************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:51 +0000 (0:00:00.934)       0:00:32.796 *********
ok: [host21]

TASK [webserver : Nginx. Copy index.html file] **********************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:52 +0000 (0:00:00.964)       0:00:33.760 *********
ok: [host21]

TASK [webserver : Nginx. Copy site configuration file] **************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:53 +0000 (0:00:01.378)       0:00:35.139 *********
ok: [host21]

TASK [webserver : Nginx. Creating symlink for site] *****************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:55 +0000 (0:00:01.431)       0:00:36.571 *********
skipping: [host21]

TASK [webserver : Nginx. Remove default index.html file] ************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:55 +0000 (0:00:00.137)       0:00:36.708 *********
ok: [host21]

TASK [webserver : Nginx. Creating site directory] *******************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:56 +0000 (0:00:00.969)       0:00:37.677 *********
ok: [host21]

TASK [webserver : Nginx. Creating new config directory for sites] ***************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:57 +0000 (0:00:01.010)       0:00:38.687 *********
ok: [host21]

TASK [webserver : Nginx. Creating symlink directory] ****************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:58 +0000 (0:00:00.911)       0:00:39.599 *********
ok: [host21]

TASK [webserver : Nginx. Copy index.html file] **********************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:43:59 +0000 (0:00:00.924)       0:00:40.523 *********
ok: [host21]

TASK [webserver : Nginx. Copy site configuration file] **************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:44:00 +0000 (0:00:01.493)       0:00:42.017 *********
ok: [host21]

TASK [webserver : Nginx. Creating symlink for site] *****************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:44:02 +0000 (0:00:01.513)       0:00:43.530 *********
skipping: [host21]

TASK [webserver : Check deploy] *************************************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:44:02 +0000 (0:00:00.175)       0:00:43.706 *********
included: /home/vagrant/07.Ansible.Cruise/roles/webserver/tasks/check_deploy.yaml for host21, host22

TASK [webserver : Check deploy. Check connection to Localhost] ******************************************************************************************************************************************************************************
Saturday 02 July 2022  15:44:02 +0000 (0:00:00.292)       0:00:43.998 *********
ok: [host21]
ok: [host22]

TASK [webserver : print out] ****************************************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:44:03 +0000 (0:00:01.096)       0:00:45.095 *********
ok: [host21] => {
    "msg": "port: 80 | state: started"
}
ok: [host22] => {
    "msg": "port: 80 | state: started"
}

TASK [webserver : Check deploy. Modifying /etc/hosts file] **********************************************************************************************************************************************************************************
Saturday 02 July 2022  15:44:03 +0000 (0:00:00.188)       0:00:45.283 *********
ok: [host21]
ok: [host22]

TASK [webserver : Check deploy. Check content of the sites] *********************************************************************************************************************************************************************************
Saturday 02 July 2022  15:44:05 +0000 (0:00:01.788)       0:00:47.072 *********
ok: [host21] => (item={'name': 'local-cent.site1', 'ip': '192.168.202.21'})
ok: [host22] => (item={'name': 'local-cent.site1', 'ip': '192.168.202.21'})
ok: [host21] => (item={'name': 'local-cent.site2', 'ip': '192.168.202.21'})
ok: [host22] => (item={'name': 'local-cent.site2', 'ip': '192.168.202.21'})
ok: [host21] => (item={'name': 'local-deb.site1', 'ip': '192.168.202.22'})
ok: [host22] => (item={'name': 'local-deb.site1', 'ip': '192.168.202.22'})
ok: [host21] => (item={'name': 'local-deb.site2', 'ip': '192.168.202.22'})
ok: [host22] => (item={'name': 'local-deb.site2', 'ip': '192.168.202.22'})

PLAY RECAP **********************************************************************************************************************************************************************************************************************************
host21                     : ok=25   changed=0    unreachable=0    failed=0    skipped=3    rescued=0    ignored=0
host22                     : ok=23   changed=0    unreachable=0    failed=0    skipped=3    rescued=0    ignored=0

Saturday 02 July 2022  15:44:10 +0000 (0:00:04.444)       0:00:51.517 *********
===============================================================================
webserver : Check deploy. Check content of the sites --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 4.45s
Gathering Facts ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 3.24s
webserver : Nginx. Install packages -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 3.14s
webserver : Nginx. Copy index.html file ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 1.85s
webserver : Check deploy. Modifying /etc/hosts file ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 1.79s
webserver : Nginx. Enable and start service ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ 1.76s
webserver : Nginx. Copy index.html file ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 1.64s
webserver : Nginx. Copy site configuration file -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 1.59s
webserver : Nginx. Copy site configuration file -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 1.55s
webserver : Nginx. Install packages -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 1.55s
webserver : Nginx. Copy site configuration file -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 1.51s
webserver : Nginx. Enable firewall port ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 1.50s
webserver : Nginx. Copy index.html file ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 1.49s
webserver : Nginx. Copy site configuration file -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 1.43s
webserver : Nginx. Copy index.html file ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 1.38s
webserver : Nginx. Remove default index.html file ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ 1.24s
webserver : Nginx. Enable and start service ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ 1.14s
webserver : Check deploy. Check connection to Localhost ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ 1.10s
webserver : Add repository ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 1.09s
webserver : Nginx. Creating new config directory for sites --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 1.08s
Playbook run took 0 days, 0 hours, 0 minutes, 51 seconds

```


## Role **testing** 

Role **testing** provide next checks:
* Check if we have SUDO with NOPASSWD
* Check connections to public repositories (Debian/CentOS and pip package repository)
* Check if we have connection to docker hub registry (return content check)
* Check if we have enough RAM/HDD on remote host

## Output of playing **testing** role:

```
vagrant@vagrant-ubuntu-20:~/07.Ansible.Cruise$ ansible-playbook -i inventory.yaml test.yaml -l "all_workers" -u root --ask-vault-pass
Vault password:

PLAY [all_workers] **************************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] **********************************************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:45:10 +0000 (0:00:00.081)       0:00:00.081 *********
ok: [host21]
ok: [host22]

TASK [testing : Check if have SUDO with NOPASSWD] *******************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:45:13 +0000 (0:00:03.093)       0:00:03.175 *********
ok: [host21]
ok: [host22]

TASK [testing : Check connections to public repositories] ***********************************************************************************************************************************************************************************
Saturday 02 July 2022  15:45:14 +0000 (0:00:01.014)       0:00:04.189 *********
ok: [host22] => (item=http://deb.debian.org/debian)
ok: [host21] => (item=http://deb.debian.org/debian)
ok: [host21] => (item=http://mirror.centos.org/centos/)
ok: [host22] => (item=http://mirror.centos.org/centos/)
ok: [host21] => (item=https://pypi.org/)
ok: [host22] => (item=https://pypi.org/)

TASK [testing : Print status connection] ****************************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:45:18 +0000 (0:00:03.724)       0:00:07.914 *********
ok: [host21] => {
    "msg": "All items completed"
}
ok: [host22] => {
    "msg": "All items completed"
}

TASK [testing : Check connection to Docker hub] *********************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:45:18 +0000 (0:00:00.186)       0:00:08.100 *********
ok: [host22] => (item=https://hub.docker.com)
ok: [host21] => (item=https://hub.docker.com)
ok: [host22] => (item=https://registry.hub.docker.com)
ok: [host21] => (item=https://registry.hub.docker.com)

TASK [testing : Check RAM/capacity/free] ****************************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:45:22 +0000 (0:00:03.184)       0:00:11.284 *********
ok: [host21] => {
    "msg": "RAM total capacity: 2048 MB | Free: 1751 MB"
}
ok: [host22] => {
    "msg": "RAM total capacity: 2048 MB | Free: 1581 MB"
}

TASK [testing : Check is RAM enough] ********************************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:45:22 +0000 (0:00:00.209)       0:00:11.494 *********
skipping: [host21]
skipping: [host22]

TASK [testing : Check is HDD space enough] **************************************************************************************************************************************************************************************************
Saturday 02 July 2022  15:45:22 +0000 (0:00:00.164)       0:00:11.659 *********
ok: [host21] => {
    "changed": false,
    "msg": "Available HDD free space: 19.0 GB is enough."
}
ok: [host22] => {
    "changed": false,
    "msg": "Available HDD free space: 18.8 GB is enough."
}

PLAY RECAP **********************************************************************************************************************************************************************************************************************************
host21                     : ok=7    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
host22                     : ok=7    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0

Saturday 02 July 2022  15:45:22 +0000 (0:00:00.453)       0:00:12.112 *********
===============================================================================
testing : Check connections to public repositories ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 3.72s
testing : Check connection to Docker hub --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 3.18s
Gathering Facts ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 3.09s
testing : Check if have SUDO with NOPASSWD ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 1.01s
testing : Check is HDD space enough -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 0.45s
testing : Check RAM/capacity/free ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 0.21s
testing : Print status connection ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 0.19s
testing : Check is RAM enough -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 0.17s
Playbook run took 0 days, 0 hours, 0 minutes, 12 seconds

```
